<div class="mx-auto max-w-7xl">
  <div class="flex items-start justify-between">
    <div class="min-w-0 flex-1">
      <h1 class="text-5xl font-bold tracking-tight text-olive-800 dark:text-[#e8ede3]">
        <%= @recipe.title %>
      </h1>
      <% if @recipe.description.present? %>
        <p class="mt-2 text-base text-gray-700 dark:text-gray-300">
          <%= @recipe.description %>
        </p>
      <% end %>
    </div>

    <div class="ml-4 flex shrink-0 gap-x-3">
      <%= link_to edit_recipe_path(@recipe),
                  class: "rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-xs inset-ring inset-ring-gray-300 hover:bg-gray-50 dark:bg-white/10 dark:text-white dark:shadow-none dark:inset-ring-white/5 dark:hover:bg-white/20" do %>
        <svg viewBox="0 0 20 20" fill="currentColor" class="-ml-0.5 size-5 inline-block" aria-hidden="true">
          <path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z" />
          <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" />
        </svg>
        Edit
      <% end %>

      <%= button_to recipe_path(@recipe),
                    method: :delete,
                    data: { turbo_confirm: "Are you sure you want to delete this recipe?" },
                    class: "rounded-md bg-dusty-rose-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-xs hover:bg-dusty-rose-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-dusty-rose-600 dark:bg-dusty-rose-500 dark:shadow-none dark:hover:bg-dusty-rose-400" do %>
        Delete
      <% end %>
    </div>
  </div>

  <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-3">
    <div class="lg:col-span-2">
      <!-- Nutrition Info Section -->
      <% if @recipe.servings.present? %>
            <!-- Chart -->
            <div class="flex flex-col items-center justify-center" data-controller="chart">

                <canvas
                  data-controller="chartjs"
                  data-chartjs-type-value="pie"
                  data-chartjs-data-value='<%= @recipe.macros_chart_data.to_json %>'
                  data-chartjs-options-value='<%= {
                                                    responsive: true,
                                                    maintainAspectRatio: true,
                                                    plugins: {
                                                      legend: {
                                                        display: true,
                                                        position: "left"
                                                      }
                                                    },

                                                  }.to_json %>'
                  style="max-height: 250px; max-width: 600px">
                </canvas>

            <p class="mt-4 text-xs text-gray-500 dark:text-gray-400 text-center">
              <%= (@recipe.total_calories/@recipe.servings).to_i %> calories per serving â€” Makes <%= @recipe.servings %> <%= "serving".pluralize(@recipe.servings) %>
            </p>
        </div>
      <% end %>
    </div>
    <div class="lg:col-span-1">
    <div class="rounded-lg bg-white p-6 shadow-sm inset-ring inset-ring-gray-900/5 dark:bg-white/5 dark:inset-ring-white/10">

      <% if @recipe.tags.any? %>
        <div class="mt-4 flex flex-wrap gap-2">
          <% @recipe.tags.each do |tag| %>
            <span class="inline-flex items-center gap-x-1.5 rounded-full px-3 py-1 text-sm font-medium inset-ring inset-ring-gray-900/10 dark:inset-ring-white/10"
                  style="background-color: <%= tag.color %>20; color: <%= tag.color %>;">
              <%= tag.tag %>
              <%= button_to recipe_recipe_tag_path(@recipe, @recipe.recipe_tags.find_by(tag: tag)),
                            method: :delete,
                            data: { turbo_confirm: "Remove this tag?" },
                            class: "inline-flex shrink-0" do %>
                <svg viewBox="0 0 20 20" fill="currentColor" class="size-4" aria-hidden="true">
                  <path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
                </svg>
              <% end %>
            </span>
          <% end %>
        </div>
      <% else %>
        <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">No tags yet. Add some to categorize this recipe.</p>
      <% end %>

      <div class=" mt-4 border-t border-gray-200 pt-4 dark:border-white/10">
        <%= form_with model: [@recipe, @recipe.recipe_tags.build], class: "flex gap-x-3" do |form| %>
          <%= form.select :tag_id,
                          options_from_collection_for_select(Tag.all, :id, :tag),
                          { prompt: "Select a tag" },
                          class: "block rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-[#5f734c] sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:focus:outline-[#7a8f62]" %>

          <%= form.submit "Add Tag",
                          class: "rounded-md bg-[#5f734c] px-3.5 py-2.5 text-sm font-semibold text-white shadow-xs hover:bg-[#4b5a3d] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#5f734c] dark:bg-[#7a8f62] dark:shadow-none dark:hover:bg-[#5f734c]" %>
        <% end %>

        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
          Or <%= link_to "create a new tag", new_tag_path, class: "font-medium text-[#5f734c] hover:text-[#4b5a3d] dark:text-[#7a8f62]" %>
        </p>
      </div>
    </div>
  </div>
  </div>

  <div class="mt-8 grid grid-cols-1 gap-8 lg:grid-cols-3">
    <div class="lg:col-span-1">
      <div class="rounded-lg bg-white p-6 shadow-sm inset-ring inset-ring-gray-900/5 dark:bg-white/5 dark:inset-ring-white/10">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Ingredients</h2>
        </div>

        <% if @recipe.recipe_ingredients.any? %>
          <div class="overflow-hidden">
          <table class=" min-w-full divide-y divide-gray-300 dark:divide-white/10">
            <tbody class="divide-y divide-gray-200 bg-white dark:divide-white/10 dark:bg-white/5">
            <% @recipe.recipe_ingredients.each do |recipe_ingredient| %>
              <tr>
                <td class="whitespace-nowrap py-4  text-sm font-medium  dark:text-white">
                  <%= link_to recipe_ingredient.ingredient do %>
                    <span class="text-sm font-medium text-gray-900 hover:text-[#5f734c] dark:text-white dark:hover:text-[#7a8f62]">
                      <%= recipe_ingredient.ingredient.ingredient %>
                    </span>
                  <% end %>
                </td>
                <td class="whitespace-nowrap text-center  text-sm text-gray-500 dark:text-gray-400">
                  <%= ingredient_family_tag(recipe_ingredient.ingredient.family) || "-" %>
                </td>
                <td class="whitespace-nowrap text-center px-2 text-sm text-gray-500 dark:text-gray-400">
                  <%= recipe_ingredient.quantity %> <%= recipe_ingredient.unit %>
                </td>
                <td class="relative whitespace-nowrap  text-right text-sm font-medium sm:pr-6">
                  <%= button_to recipe_recipe_ingredient_path(@recipe, recipe_ingredient),
                                method: :delete,
                                data: { turbo_confirm: "Remove this ingredient?" },
                                class: "shrink-0 text-dusty-rose-600 hover:text-dusty-rose-500 dark:text-dusty-rose-400" do %>
                    <svg viewBox="0 0 20 20" fill="currentColor" class="size-4" aria-hidden="true">
                      <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                    </svg>
                  <% end %>

                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
          </div>
        <% else %>
          <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">No ingredients yet. Add some below.</p>
        <% end %>

        <div class="mt-4 border-t border-gray-200 pt-4 dark:border-white/10">
          <%= form_with model: [@recipe, @recipe.recipe_ingredients.build], class: "space-y-3" do |form| %>
            <div>
              <%= form.label :quantity, class: "block text-sm/6 font-medium text-gray-900 dark:text-white" %>
              <%= form.number_field :quantity,
                                    step: 0.01,
                                    placeholder: "2",
                                    required: true,
                                    class: "mt-2 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#5f734c] sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:focus:outline-[#7a8f62]" %>
            </div>

            <div>
              <%= form.label :unit, class: "block text-sm/6 font-medium text-gray-900 dark:text-white" %>
              <%= form.text_field :unit,
                                  placeholder: "cups",
                                  required: true,
                                  class: "mt-2 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#5f734c] sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:focus:outline-[#7a8f62]" %>
            </div>

            <div>
              <%= form.label :ingredient_id, "Ingredient", class: "block text-sm/6 font-medium text-gray-900 dark:text-white" %>
              <%= form.select :ingredient_id,
                              options_from_collection_for_select(Ingredient.all.order(:ingredient), :id, :ingredient),
                              { prompt: "Select ingredient" },
                              required: true,
                              class: "mt-2 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-[#5f734c] sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:focus:outline-[#7a8f62]" %>
            </div>

            <%= form.submit "Add Ingredient",
                            class: "w-full rounded-md bg-[#5f734c] px-3.5 py-2.5 text-sm font-semibold text-white shadow-xs hover:bg-[#4b5a3d] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#5f734c] dark:bg-[#7a8f62] dark:shadow-none dark:hover:bg-[#5f734c]" %>
          <% end %>

          <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
            Or <%= link_to "create a new ingredient", new_ingredient_path, class: "font-medium text-[#5f734c] hover:text-[#4b5a3d] dark:text-[#7a8f62]" %>
          </p>
        </div>
      </div>
    </div>

    <!-- Steps Section (2/3 width on desktop) -->
    <div class="lg:col-span-2">
      <div class="rounded-lg bg-white p-6 shadow-sm inset-ring inset-ring-gray-900/5 dark:bg-white/5 dark:inset-ring-white/10">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Instructions</h2>
        </div>

        <% if @recipe.steps.any? %>
          <ol class="mt-4 space-y-4" data-controller="sortable" data-sortable-url-value="<%= reorder_recipe_steps_path(@recipe) %>">
            <% @recipe.steps.order(:position).each_with_index do |step, index| %>
              <li class="flex gap-x-4" data-sortable-target="item" data-id="<%= step.id %>">
                <!-- Drag handle -->
                <div class="flex items-start pt-2">
                  <button type="button" class="sortable-handle cursor-move text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-400">
                    <svg viewBox="0 0 20 20" fill="currentColor" class="size-5" aria-hidden="true">
                      <path fill-rule="evenodd" d="M10 3a.75.75 0 0 1 .55.24l3.25 3.5a.75.75 0 1 1-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 0 1-1.1-1.02l3.25-3.5A.75.75 0 0 1 10 3Zm-3.76 9.2a.75.75 0 0 1 1.06.04l2.7 2.908 2.7-2.908a.75.75 0 1 1 1.1 1.02l-3.25 3.5a.75.75 0 0 1-1.1 0l-3.25-3.5a.75.75 0 0 1 .04-1.06Z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>

                <!-- Step number circle -->
                <div class="step-number flex size-10 shrink-0 items-center justify-center rounded-full bg-[#5f734c] text-base font-semibold text-white dark:bg-[#7a8f62]">
                  <%= index + 1 %>
                </div>

                <!-- Step content -->
                <div class="flex-1 min-w-0">
                  <div class="pdusty-rose pdusty-rose-sm max-w-none text-gray-900 dark:pdusty-rose-invert dark:text-white">
                    <%= step.content %>
                  </div>

                  <div class="mt-2 flex items-center gap-x-4">
                    <%= link_to "Edit", edit_recipe_step_path(@recipe, step),
                                class: "text-sm font-medium text-[#5f734c] hover:text-[#4b5a3d] dark:text-[#7a8f62]" %>

                    <%= button_to recipe_step_path(@recipe, step),
                                  method: :delete,
                                  data: { turbo_confirm: "Delete this step?" },
                                  class: "text-sm font-medium text-dusty-rose-600 hover:text-dusty-rose-500 dark:text-dusty-rose-400" do %>
                      Delete
                    <% end %>
                  </div>
                </div>
              </li>
            <% end %>
          </ol>
        <% else %>
          <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">No steps yet. Add your first step below.</p>
        <% end %>

        <div class="mt-4 border-t border-gray-200 pt-4 dark:border-white/10">
          <%= link_to new_recipe_step_path(@recipe),
                      class: "inline-flex items-center gap-x-2 rounded-md bg-[#5f734c] px-3.5 py-2.5 text-sm font-semibold text-white shadow-xs hover:bg-[#4b5a3d] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#5f734c] dark:bg-[#7a8f62] dark:shadow-none dark:hover:bg-[#5f734c]" do %>
            <svg viewBox="0 0 20 20" fill="currentColor" class="-ml-0.5 size-5" aria-hidden="true">
              <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
            </svg>
            Add Step
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-8">
    <%= link_to recipes_path, class: "inline-flex items-center gap-x-1.5 text-sm font-semibold text-gray-900 hover:text-[#5f734c] dark:text-white dark:hover:text-[#7a8f62]" do %>
      <svg viewBox="0 0 20 20" fill="currentColor" class="size-5" aria-hidden="true">
        <path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" />
      </svg>
      Back to recipes
    <% end %>
  </div>
</div>